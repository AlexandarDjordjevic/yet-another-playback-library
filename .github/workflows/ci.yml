name: CI

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

env:
  BUILD_TYPE: Debug

jobs:
  build-and-test:
    name: Build and Test (Ubuntu)
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ninja-build \
          libsdl2-dev \
          libavcodec-dev \
          libavformat-dev \
          libavutil-dev \
          libswscale-dev

    - name: Configure CMake
      run: cmake --preset debug-linux

    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}}

    - name: Test
      run: ctest --test-dir build --output-on-failure --verbose

  sanitizer-asan:
    name: AddressSanitizer
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ninja-build \
          libsdl2-dev \
          libavcodec-dev \
          libavformat-dev \
          libavutil-dev \
          libswscale-dev

    - name: Configure CMake (ASan)
      run: cmake --preset asan-linux

    - name: Build
      run: cmake --build build-asan

    - name: Test with ASan
      env:
        ASAN_OPTIONS: detect_leaks=1:check_initialization_order=1:strict_init_order=1:halt_on_error=0
      run: ctest --test-dir build-asan --output-on-failure --verbose

  sanitizer-tsan:
    name: ThreadSanitizer
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ninja-build \
          libsdl2-dev \
          libavcodec-dev \
          libavformat-dev \
          libavutil-dev \
          libswscale-dev

    - name: Configure CMake (TSan)
      run: cmake --preset tsan-linux

    - name: Build
      run: cmake --build build-tsan

    - name: Test with TSan
      env:
        TSAN_OPTIONS: second_deadlock_stack=1:halt_on_error=0
      run: ctest --test-dir build-tsan --output-on-failure --verbose

  sanitizer-ubsan:
    name: UndefinedBehaviorSanitizer
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ninja-build \
          libsdl2-dev \
          libavcodec-dev \
          libavformat-dev \
          libavutil-dev \
          libswscale-dev

    - name: Configure CMake (UBSan)
      run: cmake --preset ubsan-linux

    - name: Build
      run: cmake --build build-ubsan

    - name: Test with UBSan
      env:
        UBSAN_OPTIONS: print_stacktrace=1:halt_on_error=0
      run: ctest --test-dir build-ubsan --output-on-failure --verbose

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ninja-build \
          lcov \
          libsdl2-dev \
          libavcodec-dev \
          libavformat-dev \
          libavutil-dev \
          libswscale-dev

    - name: Configure CMake (Coverage)
      run: cmake --preset coverage-linux

    - name: Build
      run: cmake --build build-coverage

    - name: Test
      run: ctest --test-dir build-coverage --output-on-failure

    - name: Generate coverage report
      run: |
        lcov --capture \
             --directory build-coverage \
             --output-file build-coverage/coverage.info \
             --rc lcov_branch_coverage=1

        lcov --remove build-coverage/coverage.info \
             '/usr/*' \
             '*/tests/*' \
             '*/build*/_deps/*' \
             '*/examples/*' \
             '*/benchmarks/*' \
             --output-file build-coverage/coverage.info \
             --rc lcov_branch_coverage=1

        lcov --list build-coverage/coverage.info --rc lcov_branch_coverage=1

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: build-coverage/coverage.info
        flags: unittests
        name: codecov-yapl
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

  benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ninja-build \
          libsdl2-dev \
          libavcodec-dev \
          libavformat-dev \
          libavutil-dev \
          libswscale-dev

    - name: Configure CMake (Release)
      run: cmake --preset release-linux

    - name: Build
      run: cmake --build build-release

    - name: Run benchmarks
      run: |
        ./build-release/benchmarks/yapl_benchmarks \
          --benchmark_min_time=0.1 \
          --benchmark_out=benchmark_results.json \
          --benchmark_out_format=json

    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: benchmark_results.json
        retention-days: 30
