name: CI

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

env:
  BUILD_TYPE: Debug
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  CCACHE_MAXSIZE: 500M

jobs:
  build-and-test:
    name: Build and Test (Ubuntu)
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Cache APT packages
      uses: actions/cache@v4
      with:
        path: /var/cache/apt/archives
        key: apt-${{ runner.os }}-${{ hashFiles('.github/workflows/ci.yml') }}
        restore-keys: |
          apt-${{ runner.os }}-

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ccache \
          ninja-build \
          libspdlog-dev \
          libfmt-dev \
          libsdl2-dev \
          libavcodec-dev \
          libavformat-dev \
          libavutil-dev \
          libswscale-dev \
          libswresample-dev \
          libcurl4-openssl-dev \
          libgtest-dev

    - name: Setup ccache
      uses: actions/cache@v4
      with:
        path: .ccache
        key: ccache-${{ runner.os }}-debug-${{ github.sha }}
        restore-keys: |
          ccache-${{ runner.os }}-debug-

    - name: Configure CMake
      run: |
        export PATH="/usr/lib/ccache:$PATH"
        cmake --preset debug-linux -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

    - name: Build
      run: |
        export PATH="/usr/lib/ccache:$PATH"
        cmake --build build --config ${{env.BUILD_TYPE}}
        ccache -s

    - name: Test
      run: ctest --test-dir build --output-on-failure --verbose

  sanitizer-asan:
    name: AddressSanitizer
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
    - uses: actions/checkout@v4

    - name: Cache APT packages
      uses: actions/cache@v4
      with:
        path: /var/cache/apt/archives
        key: apt-${{ runner.os }}-${{ hashFiles('.github/workflows/ci.yml') }}
        restore-keys: |
          apt-${{ runner.os }}-

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ccache \
          ninja-build \
          libspdlog-dev \
          libfmt-dev \
          libsdl2-dev \
          libavcodec-dev \
          libavformat-dev \
          libavutil-dev \
          libswscale-dev \
          libswresample-dev \
          libcurl4-openssl-dev \
          libgtest-dev

    - name: Setup ccache
      uses: actions/cache@v4
      with:
        path: .ccache
        key: ccache-${{ runner.os }}-asan-${{ github.sha }}
        restore-keys: |
          ccache-${{ runner.os }}-asan-

    - name: Configure CMake (ASan)
      run: |
        export PATH="/usr/lib/ccache:$PATH"
        cmake --preset asan-linux -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

    - name: Build
      run: |
        export PATH="/usr/lib/ccache:$PATH"
        cmake --build build-asan
        ccache -s

    - name: Test with ASan
      env:
        ASAN_OPTIONS: detect_leaks=1:check_initialization_order=1:strict_init_order=1:halt_on_error=0
      run: ctest --test-dir build-asan --output-on-failure --verbose

  sanitizer-tsan:
    name: ThreadSanitizer
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
    - uses: actions/checkout@v4

    - name: Cache APT packages
      uses: actions/cache@v4
      with:
        path: /var/cache/apt/archives
        key: apt-${{ runner.os }}-${{ hashFiles('.github/workflows/ci.yml') }}
        restore-keys: |
          apt-${{ runner.os }}-

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ccache \
          ninja-build \
          libspdlog-dev \
          libfmt-dev \
          libsdl2-dev \
          libavcodec-dev \
          libavformat-dev \
          libavutil-dev \
          libswscale-dev \
          libswresample-dev \
          libcurl4-openssl-dev \
          libgtest-dev

    - name: Setup ccache
      uses: actions/cache@v4
      with:
        path: .ccache
        key: ccache-${{ runner.os }}-tsan-${{ github.sha }}
        restore-keys: |
          ccache-${{ runner.os }}-tsan-

    - name: Configure CMake (TSan)
      run: |
        export PATH="/usr/lib/ccache:$PATH"
        cmake --preset tsan-linux -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

    - name: Build
      run: |
        export PATH="/usr/lib/ccache:$PATH"
        cmake --build build-tsan
        ccache -s

    - name: Test with TSan
      env:
        TSAN_OPTIONS: second_deadlock_stack=1:halt_on_error=0
      run: ctest --test-dir build-tsan --output-on-failure --verbose

  sanitizer-ubsan:
    name: UndefinedBehaviorSanitizer
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
    - uses: actions/checkout@v4

    - name: Cache APT packages
      uses: actions/cache@v4
      with:
        path: /var/cache/apt/archives
        key: apt-${{ runner.os }}-${{ hashFiles('.github/workflows/ci.yml') }}
        restore-keys: |
          apt-${{ runner.os }}-

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ccache \
          ninja-build \
          libspdlog-dev \
          libfmt-dev \
          libsdl2-dev \
          libavcodec-dev \
          libavformat-dev \
          libavutil-dev \
          libswscale-dev \
          libswresample-dev \
          libcurl4-openssl-dev \
          libgtest-dev

    - name: Setup ccache
      uses: actions/cache@v4
      with:
        path: .ccache
        key: ccache-${{ runner.os }}-ubsan-${{ github.sha }}
        restore-keys: |
          ccache-${{ runner.os }}-ubsan-

    - name: Configure CMake (UBSan)
      run: |
        export PATH="/usr/lib/ccache:$PATH"
        cmake --preset ubsan-linux -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

    - name: Build
      run: |
        export PATH="/usr/lib/ccache:$PATH"
        cmake --build build-ubsan
        ccache -s

    - name: Test with UBSan
      env:
        UBSAN_OPTIONS: print_stacktrace=1:halt_on_error=0
      run: ctest --test-dir build-ubsan --output-on-failure --verbose

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: [sanitizer-asan, sanitizer-tsan, sanitizer-ubsan]

    steps:
    - uses: actions/checkout@v4

    - name: Cache APT packages
      uses: actions/cache@v4
      with:
        path: /var/cache/apt/archives
        key: apt-${{ runner.os }}-${{ hashFiles('.github/workflows/ci.yml') }}
        restore-keys: |
          apt-${{ runner.os }}-

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ccache \
          ninja-build \
          lcov \
          libspdlog-dev \
          libfmt-dev \
          libsdl2-dev \
          libavcodec-dev \
          libavformat-dev \
          libavutil-dev \
          libswscale-dev \
          libswresample-dev \
          libcurl4-openssl-dev \
          libgtest-dev

    - name: Setup ccache
      uses: actions/cache@v4
      with:
        path: .ccache
        key: ccache-${{ runner.os }}-coverage-${{ github.sha }}
        restore-keys: |
          ccache-${{ runner.os }}-coverage-

    - name: Configure CMake (Coverage)
      run: |
        export PATH="/usr/lib/ccache:$PATH"
        cmake --preset coverage-linux -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

    - name: Build
      run: |
        export PATH="/usr/lib/ccache:$PATH"
        cmake --build build-coverage
        ccache -s

    - name: Test
      run: ctest --test-dir build-coverage --output-on-failure

    - name: Generate coverage report
      run: |
        lcov --capture \
             --directory build-coverage \
             --output-file build-coverage/coverage.info \
             --rc lcov_branch_coverage=1 \
             --ignore-errors mismatch

        lcov --remove build-coverage/coverage.info \
             '/usr/*' \
             '*/tests/*' \
             '*/build*/_deps/*' \
             '*/examples/*' \
             '*/benchmarks/*' \
             --output-file build-coverage/coverage.info \
             --rc lcov_branch_coverage=1

        lcov --list build-coverage/coverage.info --rc lcov_branch_coverage=1

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: build-coverage/coverage.info
        flags: unittests
        name: codecov-yapl
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

  benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    needs: [sanitizer-asan, sanitizer-tsan, sanitizer-ubsan]

    steps:
    - uses: actions/checkout@v4

    - name: Cache APT packages
      uses: actions/cache@v4
      with:
        path: /var/cache/apt/archives
        key: apt-${{ runner.os }}-${{ hashFiles('.github/workflows/ci.yml') }}
        restore-keys: |
          apt-${{ runner.os }}-

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ccache \
          ninja-build \
          libspdlog-dev \
          libfmt-dev \
          libsdl2-dev \
          libavcodec-dev \
          libavformat-dev \
          libavutil-dev \
          libswscale-dev \
          libswresample-dev \
          libcurl4-openssl-dev \
          libgtest-dev

    - name: Setup ccache
      uses: actions/cache@v4
      with:
        path: .ccache
        key: ccache-${{ runner.os }}-release-${{ github.sha }}
        restore-keys: |
          ccache-${{ runner.os }}-release-

    - name: Configure CMake (Release)
      run: |
        export PATH="/usr/lib/ccache:$PATH"
        cmake --preset release-linux -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

    - name: Build
      run: |
        export PATH="/usr/lib/ccache:$PATH"
        cmake --build build-release
        ccache -s

    - name: Run benchmarks
      run: |
        ./build-release/benchmarks/yapl_benchmarks \
          --benchmark_min_time=0.1 \
          --benchmark_out=benchmark_results.json \
          --benchmark_out_format=json

    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: benchmark_results.json
        retention-days: 30
